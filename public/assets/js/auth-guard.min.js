// Client-side authentication guard
(function() {
    'use strict';
    
    // Prevent back button access after logout
    if (window.history && window.history.pushState) {
        window.history.pushState('forward', null, window.location.href);
        window.addEventListener('popstate', function() {
            // Check if user is still authenticated
            fetch('/ergon/api/check-auth', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.authenticated) {
                    window.location.href = '/ergon/login';
                }
            })
            .catch(() => {
                window.location.href = '/ergon/login';
            });
        });
    }
    
    // Periodic session check (every 5 minutes)
    setInterval(function() {
        fetch('/ergon/api/check-auth', {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (!data.authenticated) {
                alert('Your session has expired. Please login again.');
                window.location.href = '/ergon/login';
            }
        })
        .catch(() => {
            // Network error, don't redirect
        });
    }, 300000); // 5 minutes
    
    // Disable browser cache for authenticated pages
    if (window.location.pathname.includes('/dashboard') || 
        window.location.pathname.includes('/admin') || 
        window.location.pathname.includes('/owner') || 
        window.location.pathname.includes('/user')) {
        
        // Set no-cache headers via meta tags
        var meta = document.createElement('meta');
        meta.httpEquiv = 'Cache-Control';
        meta.content = 'no-cache, no-store, must-revalidate';
        document.head.appendChild(meta);
        
        meta = document.createElement('meta');
        meta.httpEquiv = 'Pragma';
        meta.content = 'no-cache';
        document.head.appendChild(meta);
        
        meta = document.createElement('meta');
        meta.httpEquiv = 'Expires';
        meta.content = '0';
        document.head.appendChild(meta);
    }
})();