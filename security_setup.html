<!DOCTYPE html>
<html>
<head>
    <title>Security Setup - Ergon</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .success { color: green; } .error { color: red; } .info { color: blue; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîê Ergon Security Setup</h1>
    
    <div class="step">
        <h2>Step 1: Database Setup</h2>
        <p>Run these SQL commands in your database:</p>
        <pre>
-- Add security columns to users table (skip if already exists)
ALTER TABLE users ADD COLUMN IF NOT EXISTS reset_token VARCHAR(64) NULL;
ALTER TABLE users ADD COLUMN IF NOT EXISTS reset_token_expires DATETIME NULL;
ALTER TABLE users ADD COLUMN IF NOT EXISTS password_changed_at DATETIME NULL;
ALTER TABLE users ADD COLUMN IF NOT EXISTS locked_until DATETIME NULL;
ALTER TABLE users ADD COLUMN IF NOT EXISTS failed_attempts INT DEFAULT 0;

-- Create login attempts table
CREATE TABLE IF NOT EXISTS login_attempts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    success TINYINT(1) NOT NULL DEFAULT 0,
    attempted_at DATETIME NOT NULL,
    ip_address VARCHAR(45) NOT NULL,
    user_agent TEXT,
    INDEX idx_email_time (email, attempted_at),
    INDEX idx_ip_time (ip_address, attempted_at)
);

-- Create rate limiting table
CREATE TABLE IF NOT EXISTS rate_limit_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    identifier VARCHAR(255) NOT NULL,
    action VARCHAR(50) NOT NULL DEFAULT 'login',
    attempted_at DATETIME NOT NULL,
    success TINYINT(1) NOT NULL DEFAULT 0,
    ip_address VARCHAR(45) NOT NULL,
    INDEX idx_identifier_action_time (identifier, action, attempted_at),
    INDEX idx_ip_time (ip_address, attempted_at)
);

-- Create password change log table
CREATE TABLE IF NOT EXISTS password_change_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    changed_at DATETIME NOT NULL,
    ip_address VARCHAR(45) NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_time (user_id, changed_at)
);
        </pre>
    </div>
    
    <div class="step">
        <h2>Step 2: Email Configuration</h2>
        <p>Edit your <code>.env</code> file with SMTP settings:</p>
        <pre>
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password
FROM_EMAIL=noreply@yourcompany.com
FROM_NAME=Ergon System
        </pre>
    </div>
    
    <div class="step">
        <h2>Step 3: Test Security Features</h2>
        <ul>
            <li><strong>Account Lockout:</strong> Try 5 failed logins to trigger lockout</li>
            <li><strong>Rate Limiting:</strong> Make 10+ rapid requests to see rate limiting</li>
            <li><strong>Password Reset:</strong> Use forgot password to receive reset email</li>
        </ul>
    </div>
    
    <div class="step">
        <h2>Step 4: Maintenance (Optional)</h2>
        <p>Set up automated cleanup by running this command periodically:</p>
        <pre>php app/tasks/SecurityCleanup.php</pre>
    </div>
    
    <div class="step">
        <h2>‚úÖ Security Features Enabled</h2>
        <ul>
            <li>üîí Account lockout after 5 failed attempts</li>
            <li>‚ö° Rate limiting (10 requests per 5 minutes)</li>
            <li>üìß Email notifications for security events</li>
            <li>üõ°Ô∏è Strong password requirements (8+ chars, mixed case, numbers, symbols)</li>
            <li>üîë Secure password reset with tokens</li>
            <li>üìä Audit logging for security events</li>
        </ul>
    </div>
</body>
</html>