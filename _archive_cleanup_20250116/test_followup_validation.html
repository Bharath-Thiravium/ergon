<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow-up Validation Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 5px; }
        button { padding: 10px 20px; margin: 5px; }
        .toggle-switch { width: auto; }
        #followupFields { display: none; background: #f9f9f9; padding: 15px; margin: 10px 0; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Follow-up Validation Test</h1>
    <p>This test verifies that follow-up fields are only required when the follow-up toggle is enabled.</p>

    <form id="testForm">
        <div class="form-section">
            <h3>Basic Task Info</h3>
            <div class="form-group">
                <label for="title">Task Title *</label>
                <input type="text" id="title" name="title" required placeholder="Enter task title">
            </div>
            <div class="form-group">
                <label for="assigned_to">Assign To *</label>
                <select id="assigned_to" name="assigned_to" required>
                    <option value="">Select User</option>
                    <option value="1">Test User</option>
                </select>
            </div>
        </div>

        <div class="form-section">
            <h3>Follow-up Options</h3>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="followup_required" name="followup_required" onchange="toggleFollowupFields()" class="toggle-switch">
                    Follow-up Required
                </label>
            </div>
        </div>

        <!-- Follow-up Fields (Hidden by default) -->
        <div id="followupFields" class="form-section">
            <h3>Follow-up Details</h3>
            
            <div class="form-group">
                <label for="followup_type">Follow-up Type *</label>
                <select name="followup_type" id="followup_type">
                    <option value="standalone">Standalone Follow-up</option>
                    <option value="task" selected>Task-linked Follow-up</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="follow_up_date">Follow-up Date *</label>
                <input type="date" name="follow_up_date" id="follow_up_date">
            </div>
            
            <div class="form-group">
                <label for="followup_title">Follow-up Title *</label>
                <input type="text" name="followup_title" id="followup_title" placeholder="e.g., Follow up on proposal discussion">
            </div>
        </div>

        <div class="form-section">
            <button type="submit">Create Task</button>
            <button type="button" onclick="runTests()">Run Validation Tests</button>
        </div>
    </form>

    <div id="testResults"></div>

    <script>
        // Toggle follow-up fields
        function toggleFollowupFields() {
            const checkbox = document.getElementById('followup_required');
            const followupFields = document.getElementById('followupFields');
            
            // Get follow-up form elements that need required validation
            const followupRequiredFields = [
                document.getElementById('follow_up_date'),
                document.getElementById('followup_title'),
                document.getElementById('followup_type')
            ];
            
            if (checkbox.checked) {
                followupFields.style.display = 'block';
                
                // Add required attribute to follow-up fields
                followupRequiredFields.forEach(field => {
                    if (field) field.setAttribute('required', 'required');
                });
                
                // Set default follow-up date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('follow_up_date').value = tomorrow.toISOString().split('T')[0];
                
                // Set default title based on task title
                const taskTitle = document.getElementById('title').value;
                if (taskTitle && !document.getElementById('followup_title').value) {
                    document.getElementById('followup_title').value = 'Follow-up: ' + taskTitle;
                }
            } else {
                followupFields.style.display = 'none';
                
                // Remove required attribute from follow-up fields
                followupRequiredFields.forEach(field => {
                    if (field) field.removeAttribute('required');
                });
                
                // Clear follow-up field values to prevent submission of hidden data
                followupRequiredFields.forEach(field => {
                    if (field && field.tagName === 'INPUT') field.value = '';
                });
            }
        }

        // Form validation
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent actual submission for testing
            
            const title = document.getElementById('title').value.trim();
            const assignedTo = document.getElementById('assigned_to').value;
            const followupRequired = document.getElementById('followup_required').checked;
            
            let errors = [];
            
            if (!title) {
                errors.push('Task title is required');
            }
            
            if (!assignedTo) {
                errors.push('Assigned user is required');
            }
            
            // Validate follow-up fields only if follow-up is enabled
            if (followupRequired) {
                const followupDate = document.getElementById('follow_up_date').value.trim();
                const followupTitle = document.getElementById('followup_title').value.trim();
                
                if (!followupDate) {
                    errors.push('Follow-up date is required when follow-up is enabled');
                }
                
                if (!followupTitle) {
                    errors.push('Follow-up title is required when follow-up is enabled');
                }
            }
            
            if (errors.length > 0) {
                showTestResult('Form validation failed: ' + errors.join(', '), 'error');
            } else {
                showTestResult('Form validation passed! Task would be created successfully.', 'success');
            }
        });

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize follow-up fields state (ensure they start without required attribute)
            const followupRequiredFields = [
                document.getElementById('follow_up_date'),
                document.getElementById('followup_title'),
                document.getElementById('followup_type')
            ];
            followupRequiredFields.forEach(field => {
                if (field) field.removeAttribute('required');
            });
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('follow_up_date').min = today;
        });

        function showTestResult(message, type) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function runTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<h3>Test Results:</h3>';
            
            // Test 1: Follow-up disabled, should not require follow-up fields
            document.getElementById('followup_required').checked = false;
            toggleFollowupFields();
            
            const followupFields = [
                document.getElementById('follow_up_date'),
                document.getElementById('followup_title'),
                document.getElementById('followup_type')
            ];
            
            const hasRequiredWhenDisabled = followupFields.some(field => field.hasAttribute('required'));
            if (!hasRequiredWhenDisabled) {
                showTestResult('✓ Test 1 PASSED: Follow-up fields are not required when toggle is disabled', 'success');
            } else {
                showTestResult('✗ Test 1 FAILED: Follow-up fields still have required attribute when disabled', 'error');
            }
            
            // Test 2: Follow-up enabled, should require follow-up fields
            document.getElementById('followup_required').checked = true;
            toggleFollowupFields();
            
            const allRequiredWhenEnabled = followupFields.every(field => field.hasAttribute('required'));
            if (allRequiredWhenEnabled) {
                showTestResult('✓ Test 2 PASSED: Follow-up fields are required when toggle is enabled', 'success');
            } else {
                showTestResult('✗ Test 2 FAILED: Not all follow-up fields have required attribute when enabled', 'error');
            }
            
            // Test 3: Form submission with follow-up disabled
            document.getElementById('followup_required').checked = false;
            toggleFollowupFields();
            document.getElementById('title').value = 'Test Task';
            document.getElementById('assigned_to').value = '1';
            
            // Clear follow-up fields
            document.getElementById('follow_up_date').value = '';
            document.getElementById('followup_title').value = '';
            
            // Check if form would validate
            const form = document.getElementById('testForm');
            const isValid = form.checkValidity();
            
            if (isValid) {
                showTestResult('✓ Test 3 PASSED: Form validates successfully with follow-up disabled and empty follow-up fields', 'success');
            } else {
                showTestResult('✗ Test 3 FAILED: Form validation fails even with follow-up disabled', 'error');
            }
            
            // Reset form
            document.getElementById('followup_required').checked = false;
            toggleFollowupFields();
        }
    </script>
</body>
</html>